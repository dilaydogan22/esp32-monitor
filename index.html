<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Datalogger</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #ffffff;
            color: #000;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            border: 2px solid #000;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-top: 0;
            text-transform: uppercase;
        }
        .latest-val {
            font-size: 60px;
            font-weight: bold;
            margin: 20px 0;
        }
        .btn {
            background: #fff;
            border: 2px solid #000;
            color: #000;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        .btn:hover {
            background: #000;
            color: #fff;
        }
        .log-box {
            text-align: left;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #000;
            padding: 10px;
            margin-top: 10px;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        li {
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
        }
        .timestamp {
            font-weight: bold;
            margin-right: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>[ 24 SAAT VERI KAYDI ]</h1>
    
    <div>SON OLCUM:</div>
    <div id="latest" class="latest-val">--</div>
    
    <button onclick="downloadData()" class="btn">[ .TXT OLARAK INDIR ]</button>

    <div style="text-align:left;">> GECMIS KAYITLAR (Her 5 Dk):</div>
    
    <div class="log-box">
        <ul id="historyList">
            <li>Veriler yukleniyor...</li>
        </ul>
    </div>
</div>

<script>
    // --- FIREBASE AYARLARI ---
    const firebaseConfig = {
        apiKey: "AIzaSyBa1JYDzUTa5Hi0pg-SSTDXiDW83o49ZcA", 
        authDomain: "esp-32-distance.firebaseapp.com",
        // Senin DÜZELTTİĞİN adres:
        databaseURL: "https://esp-32-distance-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "esp-32-distance",
        storageBucket: "esp-32-distance.appspot.com",
        messagingSenderId: "1025261979304", 
        appId: "1:1025261979304:web:a36b7d8a66c5a23742649d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Geçmiş verilerin tutulacağı yol: /sensor/history
    // limitToLast(288) komutu son 288 veriyi çeker (24 saat x 12 veri)
    const historyRef = db.ref('/sensor/history').limitToLast(288);
    
    let allDataText = ""; // İndirme için metni burada biriktireceğiz

    historyRef.on('value', (snapshot) => {
        const listElement = document.getElementById('historyList');
        const latestElement = document.getElementById('latest');
        
        listElement.innerHTML = ""; // Listeyi temizle
        allDataText = "ZAMAN  | MESAFE\n----------------\n"; // Dosya başlığı
        
        let lastVal = "--";
        
        // Firebase'den gelen veriler nesne (object) olarak gelir, diziye çevirelim
        const dataArr = [];
        snapshot.forEach((childSnapshot) => {
            dataArr.push(childSnapshot.val());
        });

        // Verileri tersten (yeni en üstte) sıralayalım
        dataArr.reverse();

        if (dataArr.length > 0) {
            // En son veriyi ekrana yaz
            lastVal = dataArr[0].mesafe + " cm";
            
            // Listeyi oluştur
            dataArr.forEach((item) => {
                // Listeye Ekle
                const li = document.createElement("li");
                // Gelen veri sayı mı kontrol et (isNaN = Is Not a Number)
                let birim = isNaN(item.mesafe) ? "" : " cm"; 
                li.innerHTML = `<span class="timestamp">[ ${item.zaman} ]</span> -> ${item.mesafe}${birim}`;
                allDataText += `${item.zaman}  | ${item.mesafe}${birim}\n`;
                listElement.appendChild(li);

                // İndirme metnine ekle
                allDataText += `${item.zaman}  | ${item.mesafe} cm\n`;
            });
        } else {
            listElement.innerHTML = "<li>Henuz kayit yok.</li>";
        }
        
        latestElement.innerText = lastVal;
    });

    // --- DOSYA İNDİRME FONKSİYONU ---
    function downloadData() {
        // Metin dosyasını oluştur
        const blob = new Blob([allDataText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        
        // Gizli bir link oluşturup tıklat
        const a = document.createElement('a');
        a.href = url;
        a.download = "sensor_verileri.txt"; // İndirilen dosya adı
        document.body.appendChild(a);
        a.click();
        
        // Temizlik
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
</script>

</body>
</html>

